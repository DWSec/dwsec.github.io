<!DOCTYPE html><!-- Last Published: Fri Jan 12 2024 08:39:01 GMT+0000 (Coordinated Universal Time) --><html data-wf-page="6572f99ba87060097855250a" data-wf-site="63b6d5e577ebd8b19dbf7bfe" data-wf-collection="6572f99ba87060097855251a" data-wf-item-slug="think-offensive-leverage-osquery-for-discovery-and-enumeration"><head><meta charset="utf-8"/><title>Dark Waves Infosec Ltd</title><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="../css/dwsec.webflow.1049a7f6a.min.css" rel="stylesheet" type="text/css"/><script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script><link href="../images/favicon.png" rel="shortcut icon" type="image/x-icon"/><link href="../images/app-icon.png" rel="apple-touch-icon"/></head><body><div data-animation="default" data-collapse="medium" data-duration="400" data-easing="ease" data-easing2="ease" role="banner" class="navbar w-nav"><div class="container navbar-container"><a href="/" class="home-link w-inline-block"><img src="../images/02-white-isologotype-403x.png" loading="lazy" width="150" sizes="(max-width: 479px) 90px, (max-width: 767px) 120px, 150px" alt="" srcset="../images/02-white-isologotype-403x-p-500.png 500w, ../images/02-white-isologotype-403x-1.png 901w" class="logo"/></a><div class="menu-button w-nav-button"><div class="w-icon-nav-menu"></div></div><nav role="navigation" class="nav-menu w-nav-menu"><div class="navbar-menu-items"><a href="/about-us" class="nav-link w-inline-block"><div>About us</div><div class="nav-link-line"></div></a><a href="/services" class="nav-link w-inline-block"><div>Services</div><div class="nav-link-line"></div></a><a href="/insights" class="nav-link w-inline-block"><div>Insights</div><div class="nav-link-line"></div></a><a href="#" class="button navbar-button w-button">Contact us</a></div></nav></div></div><div class="section insight-template"><div class="scroll-indicator scroll_indicator"></div><div class="container centered"><div class="insight-header-image-contain"><div class="insight-title-wrap"><h2 class="insight-title">Think Offensive - Leverage OSQuery for Discovery and Enumeration</h2><div class="insight-date">June 29, 2023</div></div><div style="background-image:url(&quot;../images/osquery-1.jpeg&quot;)" class="insight-header-image"></div></div><div class="insight-post-contain"><div class="inisght-rich-text-block w-richtext"><p><strong>TL;DR</strong></p><p>The purpose of this post is to explain how to leverage Osquery to perform enumeration and discovery of a system without relying on Living Off the Land Binaries (LOLBins) such as net, sc, and schtasks. These tools are commonly monitored in enforced environments and used for enumerating users, services, and tasks on Windows machines.</p><p>While the post will focus on Windows machines, as they are still the mainstream in the industry, the methods described in this post can be easily translated to other platforms.</p><p>It is important to note that this post will not cover the in-depth implementation of Osquery but will instead highlight its key implementation points.</p><p><strong>What is Osquery?</strong></p><p>Osquery is a free and open-source tool that enables developers, security teams, and system administrators to perform high-speed, low-latency SQL queries against their operating system to gain insights and investigate issues. It allows users to treat the operating system as a relational database, where tables represent different types of system information such as running processes, loaded kernel modules, open network connections, and much more. Osquery is designed to work on multiple operating systems including macOS, Linux, Windows, and FreeBSD. It&#x27;s widely used for security monitoring, compliance auditing, and fleet management.</p><p><strong>Brief technical breakdown of Osquery</strong></p><p>From an offensive security researcher perspective, the following key points are important to know about the implementation of this project:</p><ul role="list"><li>The project is built using Modern C++.</li><li>The project is designed with security in mind.</li><li>The project has numerous third-party dependencies, such as XML, JSON parsers.</li><li>The project is statically compiled.</li><li>Osquery supports various programming languages for extensions.</li><li>The daemon runs with privileged access on the system.</li><li>Sockets (Named pipes on Windows) are used as IPC between the client and server.</li></ul><p>Finding a vulnerability in the daemon could potentially lead to privilege escalation on the system. However, as mentioned earlier in the post, the focus of this post is not to seek out flaws in Osquery but rather to leverage the intended implementation to enumerate the machine without triggering any alarms.</p><p><strong>How Osquery Works?</strong></p><p>Osquery is shipped with the osquery interpreter (osqueryi) and osquery daemon (osqueryd) binaries, among other components. Osqueryi functions as an interactive shell usually runs as the least privileged user, while Osqueryd acts as a daemon and runs with privileged access on the system. Both binaries utilize named pipes on Windows (sockets on other platforms) for interprocess communication (IPC).</p><p>Before delving deeper into the analysis, it is important to note that both binaries are nearly indistinguishable. They share the same source code but exhibit different behaviors based on the binary filename and parameters provided. If you examine osquery/cmake/install_directives.cmake, you will come across the following set of instructions.</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/osquery_cmake_rename2osquryi.png" loading="lazy" alt=""/></div><figcaption>Renaming osqueryd to osqueryi in Windows</figcaption></figure><p>Moreover, if you examine the CMake install directives for MacOS, you will notice that osqueryi is a symbolic link to osqueryd. Furthermore, if you carefully observe the description field of both Windows binaries, you will find the phrase &#x27;osquery daemon and shell.&#x27; This reinforces our previous assertion that both binaries can function as either a daemon or a shell. An effortless method to verify this is to create a copy of osqueryd.exe, rename it to a different name, and execute it.</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/osqueryd_acts_as_osqueryi.png" loading="lazy" alt=""/></div><figcaption>Osqueryd acting as Osqueryi</figcaption></figure><p>It is important to note that osqueryi and osqueryd do not have a client-server relationship. Instead, each of them performs actions individually with different privileges. Shell interpreter implementation uses different form of local database such as sqlite, ephemeral and rocksdb.</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/osquery_sqlite_comment.png" loading="lazy" alt=""/></div><figcaption>Interactive shell using virtual tables - SQLite DB comment</figcaption></figure><p>If osquery is run by a least privileged user with some missing flags, the program will run as a shell. The depth implementation of osquery is not covered in this post; however, we will cover some aspects of the IPC implementation that we can leverage later on.</p><p>One of the key distinctions between the osquery daemon and shell in the context of IPC is that an instance of the osquery interpreter creates a named pipe with a name containing &#x27;shell.em&#x27;. On the other hand, if osquery is run as a service, it creates a named pipe called &#x27;osqueryd.em&#x27; as shown below.</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/osqueryi_namepipes.png" loading="lazy" alt=""/></div><figcaption>Several Instances of Osqueryi</figcaption></figure><p><strong>Abuse Osquery for Offensive Enumeration Purpose</strong></p><p>Now that we have some insight into how Osquery works, we can address the main purpose of this post. Thanks to Osquery&#x27;s shell interpreter implementation, we can enumerate the system using SQL-like queries.</p><p>For instance, in the accompanying screenshot, we are listing users in the system.</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/osquery_query_usernames.png" loading="lazy" alt=""/></div><figcaption>Querying users in the system using Osquery</figcaption></figure><p>Osquery has powerful built-in tables such as process_memory_map, nrfs_acl_permissions, listening_ports, pipe, ntdomains and many more, moving forward the technique depicted in the screenshot is not ideal because it requires creating a new instance of Osquery for each query. Unlike SQL, this method is unable to handle stacked queries. Although you can utilize join tables with shared columns, it adds complexity and imposes restrictions on the queries you can make.</p><p>As a workaround, we can leverage the shell&#x27;s named pipe to keep only one instance running and send as many queries as we like. From a black box perspective, we can observe that some data, along with the query, is sent to the named pipe.</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/osquery_blackbox_ioninja_highlight.png" loading="lazy" alt=""/></div><figcaption>Inspecting named pipe traffic using IO Ninja</figcaption></figure><p>While inspecting the source, we identified that the data sent along with the query is a struct named <a target="_blank" href="https://github.com/osquery/osquery/blob/master/osquery/devtools/shell.cpp#L397"><strong>callback_data</strong></a>, as shown in the following snippet.</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/runquery_callback_data_param_source_highlight.png" loading="lazy" alt=""/></div><figcaption>runQuery function definition</figcaption></figure><p>At this point, we have several options: either reinventing the wheel or utilizing an existing implementation. For the sake of simplicity, we chose osquery-go, which provides Golang bindings for Osquery. This allows us to create a new Osquery client/extension by simply providing a socket, in this case, a named pipe.</p><p>Without further ado, the following is a video demonstrating the enumeration of the system using a tool that leverages Osquery.<br/><br/></p><figure style="padding-bottom:33.723653395784545%" class="w-richtext-align-center w-richtext-figure-type-video"><div><iframe allowfullscreen="true" frameborder="0" scrolling="no" src="https://www.youtube.com/embed/uLYn7zsiHDU?start=0" title="Think Offensive - Leverage OSQuery for Discovery and Enumeration - Tool PoC"></iframe></div></figure><p>The tool checks for an existing shell.em named pipe, if the named does not exists, the tool then checks for installed Osquery binary in the system and then runs Osquery in an interactive shell, which results in the creation of shell.em named pipe that then we can use to create a new Osquery client extension using osquery-go API. You can find the complete source here.<br/>In a nutshell, this tool performs the following steps:</p><ol role="list"><li>It checks if a named pipe called shell.em already exists.</li><li>If the named pipe doesn&#x27;t exist, it proceeds to check if the Osquery binary is installed on the system.</li><li>If Osquery is installed, the tool runs it in an interactive shell.</li><li>Running Osquery in the interactive shell creates the shell.em named pipe.</li><li>The shell.em named pipe can then be utilized to create a new Osquery client extension using the osquery-go API. You can find the complete source code for this tool here.</li></ol><p>From a defensive perspective, monitoring named pipes with shell.em(\d)* is highly recommended. Usually, OSQuery works in conjunction with other platforms such as Kolide, among others, where data is sent to the cloud. Keeping an eye on third-party implementations is also highly recommended.</p><p>The source code of the tool can be found <a href="https://github.com/tahadraidia/OSQueryED">here</a>.</p><p><strong>Resources</strong></p><p><a href="https://osquery.readthedocs.io/en/stable/introduction/sql/" target="_blank">Link - Osquery.readthedocs</a></p><p><a href="https://www.securityhq.com/blog/security-101-lolbins-malware-exploitation/" target="_blank">Link - Securityhq</a></p><p><a href="https://www.osquery.io/schema/5.8.2/">Link - Osquery</a></p></div></div></div></div><div class="section more-insights"><div class="container"><div class="insights-header-flex no-left-padding"><h2 class="dark-text">Explore more insights</h2></div><div class="insights-list-wrapper w-dyn-list"><div role="list" class="insights-list w-dyn-items"><div role="listitem" class="insight-item more w-dyn-item"><a href="/insights/seh-overflow-with-multi-staged-jumps" class="insight-link-block w-inline-block"><div class="insight-card"><div class="card-left"><img alt="" loading="lazy" width="88" src="../images/01-white-isotype-40png-1.png" class="card-logo-image"/><div class="card-title-text">SEH Overflow with Multi-Staged Jumps</div></div><div style="background-image:url(&quot;../images/img0-1.webp&quot;)" class="card-right"></div></div><h2 class="card-title _30px">SEH Overflow with Multi-Staged Jumps</h2><div class="publish-date">June 26, 2020</div></a></div><div role="listitem" class="insight-item more w-dyn-item"><a href="/insights/asm-2-tutorial-different-addressing-methods-2" class="insight-link-block w-inline-block"><div class="insight-card"><div class="card-left"><img alt="" loading="lazy" width="88" src="../images/01-white-isotype-40png-1.png" class="card-logo-image"/><div class="card-title-text">ASM 2 Tutorial - Different Addressing Methods</div></div><div style="background-image:url(&quot;../images/pexels-photo-5952647.jpeg&quot;)" class="card-right"></div></div><h2 class="card-title _30px">ASM 2 Tutorial - Different Addressing Methods</h2><div class="publish-date">March 19, 2021</div></a></div><div role="listitem" class="insight-item more w-dyn-item"><a href="/insights/expanding-our-windbg-arsenal-handleex-extension" class="insight-link-block w-inline-block"><div class="insight-card"><div class="card-left"><img alt="" loading="lazy" width="88" src="../images/01-white-isotype-40png-1.png" class="card-logo-image"/><div class="card-title-text">Expanding Our WinDBG Arsenal - Handleex Extension</div></div><div style="background-image:url(&quot;../images/extensioninaction.png&quot;)" class="card-right"></div></div><h2 class="card-title _30px">Expanding Our WinDBG Arsenal - Handleex Extension</h2><div class="publish-date">May 11, 2023</div></a></div><div role="listitem" class="insight-item more w-dyn-item"><a href="/insights/exploiting-millennium-mp3-studio-2-0-with-shellcode-payload" class="insight-link-block w-inline-block"><div class="insight-card"><div class="card-left"><img alt="" loading="lazy" width="88" src="../images/01-white-isotype-40png-1.png" class="card-logo-image"/><div class="card-title-text">Exploiting Millennium MP3 Studio 2.0 with Shellcode Payload</div></div><div style="background-image:url(&quot;../images/img0-2.webp&quot;)" class="card-right"></div></div><h2 class="card-title _30px">Exploiting Millennium MP3 Studio 2.0 with Shellcode Payload</h2><div class="publish-date">June 8, 2020</div></a></div></div></div></div></div><div id="Footer" class="section footer"><div class="container"><h2 data-w-id="ae4b8e71-0363-414c-edd7-c73018081b98" class="large-text footer-heading">Security You Can Trust</h2><div class="footer-content-contain"><div class="footer-flex"><div class="footer-left"><p data-w-id="ae4b8e71-0363-414c-edd7-c73018081b9d">As we are passionate about this industry, security and research comes as a second nature for us providing our customers with unmatched results. Let&#x27;s get in touch!</p><div class="footer-contact-links-wrap"><a data-w-id="ae4b8e71-0363-414c-edd7-c73018081ba0" href="#" class="link-block w-inline-block"><div class="link-block-left"><img src="../images/free-mail-icon-142-thumb.png" loading="eager" width="20" alt="" class="contact-icon"/><div class="contact-type">Email</div></div><div class="link-block-center"><div class="contact-symbol">@</div></div><div class="link-block-right"><div class="contact">hello@darkwaves.io</div></div><div class="link-block-border"><div class="link-block-hover-border"></div></div></a><a data-w-id="ae4b8e71-0363-414c-edd7-c73018081bad" href="https://twitter.com/DarkWaves_Sec" target="_blank" class="link-block w-inline-block"><div class="link-block-left"><img src="../images/81609.png" loading="eager" width="20" sizes="20px" alt="" srcset="../images/81609-p-500.png 500w, ../images/81609-1.png 512w" class="contact-icon"/><div class="contact-type">Twitter</div></div><div class="link-block-center"><img src="../images/contact-20arrow.svg" loading="lazy" width="16" alt="" class="contact-arrow"/></div><div class="link-block-right"><div class="contact">@DarkWaves_Sec</div></div><div class="link-block-border"><div class="link-block-hover-border"></div></div></a><a data-w-id="ae4b8e71-0363-414c-edd7-c73018081bb9" href="https://www.linkedin.com/company/dwsec" target="_blank" class="link-block w-inline-block"><div class="link-block-left"><img src="../images/174857.png" loading="eager" width="20" sizes="20px" alt="" srcset="../images/174857-p-500.png 500w, ../images/174857-1.png 512w" class="contact-icon"/><div class="contact-type">LinkedIn</div></div><div class="link-block-center"><img src="../images/contact-20arrow.svg" loading="lazy" width="16" alt="" class="contact-arrow"/></div><div class="link-block-right"><div class="contact">@dwsec</div></div><div class="link-block-border"><div class="link-block-hover-border"></div></div></a></div></div><div class="footer-right"><h3 data-w-id="ae4b8e71-0363-414c-edd7-c73018081bde" class="footer-address">DARK WAVES INFOSEC LTD<br/>71-75 Shelton Street<br/>Covent Garden<br/>London<br/>WC2H 9JQ</h3><div class="_20px-height-gap-div"></div><div data-w-id="ae4b8e71-0363-414c-edd7-c73018081be5" class="copyrights">Copyright © Dark Waves Infosec LTD.<br/></div></div></div></div></div></div><script src="../js/jquery.js" type="text/javascript"  ></script><script src="../js/webflow-script.js" type="text/javascript"></script></body></html>