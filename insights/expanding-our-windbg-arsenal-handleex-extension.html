<!DOCTYPE html><!-- Last Published: Fri Jan 12 2024 08:39:01 GMT+0000 (Coordinated Universal Time) --><html data-wf-page="6572f99ba87060097855250a" data-wf-site="63b6d5e577ebd8b19dbf7bfe" data-wf-collection="6572f99ba87060097855251a" data-wf-item-slug="expanding-our-windbg-arsenal-handleex-extension"><head><meta charset="utf-8"/><title>Dark Waves Infosec Ltd</title><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="../css/dwsec.webflow.1049a7f6a.min.css" rel="stylesheet" type="text/css"/><script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script><link href="../images/favicon.png" rel="shortcut icon" type="image/x-icon"/><link href="../images/app-icon.png" rel="apple-touch-icon"/></head><body><div data-animation="default" data-collapse="medium" data-duration="400" data-easing="ease" data-easing2="ease" role="banner" class="navbar w-nav"><div class="container navbar-container"><a href="/" class="home-link w-inline-block"><img src="../images/02-white-isologotype-403x.png" loading="lazy" width="150" sizes="(max-width: 479px) 90px, (max-width: 767px) 120px, 150px" alt="" srcset="../images/02-white-isologotype-403x-p-500.png 500w, ../images/02-white-isologotype-403x-1.png 901w" class="logo"/></a><div class="menu-button w-nav-button"><div class="w-icon-nav-menu"></div></div><nav role="navigation" class="nav-menu w-nav-menu"><div class="navbar-menu-items"><a href="/about-us" class="nav-link w-inline-block"><div>About us</div><div class="nav-link-line"></div></a><a href="/services" class="nav-link w-inline-block"><div>Services</div><div class="nav-link-line"></div></a><a href="/insights" class="nav-link w-inline-block"><div>Insights</div><div class="nav-link-line"></div></a><a href="#" class="button navbar-button w-button">Contact us</a></div></nav></div></div><div class="section insight-template"><div class="scroll-indicator scroll_indicator"></div><div class="container centered"><div class="insight-header-image-contain"><div class="insight-title-wrap"><h2 class="insight-title">Expanding Our WinDBG Arsenal - Handleex Extension</h2><div class="insight-date">May 11, 2023</div></div><div style="background-image:url(&quot;../images/extensioninaction.png&quot;)" class="insight-header-image"></div></div><div class="insight-post-contain"><div class="inisght-rich-text-block w-richtext"><h2>‍<strong>Introduction</strong></h2><p>When it comes to dynamic analysis on Windows, WinDBG is our option of choice. The debugger provides several built-in extensions such as analyze, heap, gle and allows extendibility by creating extensions using several programming languages.</p><p>During an engagement for a client, a need emerged to retrieve the filename associated with a file handle, all that is within the userland.</p><p>As mentioned earlier, WinDBG comes up with diverse built-in extensions, one of which handle, and the extension displays information for the given handle.</p><blockquote><br/>0:007&gt; !handle -?<br/>!handle [&lt;handle&gt;] [&lt;flags&gt;] [&lt;type&gt;]<br/>  &lt;handle&gt; - Handle to get information about<br/>             0 or -1 means all handles<br/>  &lt;flags&gt; - Output control flags<br/>            1   - Get type information (default)<br/>            2   - Get basic information<br/>            4   - Get name information<br/>            8   - Get object specific info (where available) (space-delimited, 32-bit<br/>            max)<br/>  &lt;type&gt; - Limit query to handles of the given type<br/>Display information about open handles<br/></blockquote><p><br/>Unfortunately, the filename linked to the file handle is not displayed by the extension. However, if you are familiar with Sysinternals Suite, you may be aware of Handle Viewer, a tool that dumps handle information, including the corresponding filename.</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/nthandle_handle_filename.png" loading="lazy" alt=""/></div></figure><p>‍</p><h2><strong>How Does Nthandle Retrieve Information About a Handle?</strong></h2><p>The tool runs as a standalone application and does not require admin privileges. This means it is possible to obtain handle information from userland without any special privileges. Nonetheless, the question remains: how does Nthandle retrieve information about a handle?</p><p>Starting inspecting the imported libraries in IDA revealed the usage of common high-level modules, such as ADVAPI32, COMDLG32, GDI32, KERNEL32, and USER32.</p><p>At first glance, none of the imported APIs appeared to be directly used to retrieve information from a handle.</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/importedapis.png" loading="lazy" alt=""/></div></figure><p>‍</p><p>After renaming some labels in IDA, the main function now looks something like this.</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/mainfunction.png" loading="lazy" alt=""/></div><figcaption>main function</figcaption></figure><p>‍</p><p>At this point, the code should be self-explanatory. The functions that interest us are <strong>load_ntdll_symbols()</strong> and <strong>golden_function()</strong>.</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/code1.png" loading="lazy" alt=""/></div></figure><p>‍</p><p>Interestingly, <strong>NtQuerySystemInformation()</strong> provides several pieces of information about the system, including handle information. Furthermore, while inspecting <strong>golden_function()</strong>, we came across <strong>sub_140007980()</strong>.</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/code2.png" loading="lazy" alt=""/></div></figure><p>‍</p><p>The function obtains handle information by leveraging the <strong>NtQuerySystemInformation()</strong> API, as shown below.</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/code3.png" loading="lazy" alt=""/></div></figure><p>The NtQuerySystemInformation() API is a Windows API that allows developers to retrieve system information. One particular use case is retrieving handles information without requiring privileged permissions. The API requires the following parameters:</p><ol role="list"><li>SystemInformationClass: This parameter specifies the type of system information to retrieve. For handles information, the appropriate value is SystemHandleInformation. This class allows obtaining details about open handles in the system.</li><li>SystemInformation: This parameter is a pointer to a buffer that receives the requested system information. For handles information, the buffer should be appropriately sized to accommodate the returned data, typically an array of structures.</li><li>SystemInformationLength: This parameter specifies the size of the buffer provided in the SystemInformation parameter.</li><li>ReturnLength: An optional parameter that receives the actual size of the system information returned by the API. This helps to ensure that the provided buffer is large enough to hold the data and enables the caller to resize the buffer if needed.</li></ol><p>By using the SystemHandleInformation class with NtQuerySystemInformation(), developers can retrieve details about the handles present in the system. This information includes the handle value, process ID, object type, access rights, and other relevant details. It allows you to enumerate and analyze the handles used by processes running on the system.</p><p>One important aspect of NtQuerySystemInformation() is that it provides a way to retrieve handles information without requiring privileged permissions. While certain privileged APIs might offer more comprehensive handle-related information, NtQuerySystemInformation() can provide valuable insights for analysis and troubleshooting, even in scenarios where elevated privileges are not available.</p><h2><strong>Handleex Windbg Extension is Born</strong></h2><p>Now that we have established how Nthandle obtains information about a handle, it is time to build our own Windbg extension that allows us to retrieve the associated name of an object. To accomplish this, the extension will leverage the following undocumented APIs:</p><ul role="list"><li>NtQuerySystemInformation()</li><li>NtDuplicateObject()</li><li>NtQueryObject()</li></ul><p>NtQuerySystemInformation() will be used to retrieve all handles on the system. Since we are not running within the target process, NtDuplicateObject() will be used to duplicate the handle that we would like to obtain information about. The documented equivalent in the Windows API is DuplicateToken(). Finally, NtQueryObject() will be used to retrieve the object type and name.</p><p>The NtQueryObject() API is a Windows Native API function that can be used to retrieve various information about an object in the system, including its type and filename. To retrieve the object type, one can pass the ObjectInformationClass parameter as ObjectTypeInformation to the NtQueryObject() function. This will return information about the object, including its type. To retrieve the filename associated with the object, one can pass the ObjectInformationClass parameter as ObjectNameInformation. The function will then provide the name of the object, if available, in the returned information.</p><p>Following is a screenshot of the Windbg extension in action.</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/extensioninaction.png" loading="lazy" alt=""/></div></figure><p>‍</p><p>You can find the source code <a href="https://github.com/DWSec/windbg-arsenal/tree/main/handleex">here</a>.</p><h3><strong>Further Reading</strong></h3><ul role="list"><li>https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/</li><li>https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/-analyze</li><li>https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/-handle</li><li>https://learn.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation<br/></li></ul></div></div></div></div><div class="section more-insights"><div class="container"><div class="insights-header-flex no-left-padding"><h2 class="dark-text">Explore more insights</h2></div><div class="insights-list-wrapper w-dyn-list"><div role="list" class="insights-list w-dyn-items"><div role="listitem" class="insight-item more w-dyn-item"><a href="/insights/seh-overflow-with-multi-staged-jumps" class="insight-link-block w-inline-block"><div class="insight-card"><div class="card-left"><img alt="" loading="lazy" width="88" src="../images/01-white-isotype-40png-1.png" class="card-logo-image"/><div class="card-title-text">SEH Overflow with Multi-Staged Jumps</div></div><div style="background-image:url(&quot;../images/img0-1.webp&quot;)" class="card-right"></div></div><h2 class="card-title _30px">SEH Overflow with Multi-Staged Jumps</h2><div class="publish-date">June 26, 2020</div></a></div><div role="listitem" class="insight-item more w-dyn-item"><a href="/insights/asm-2-tutorial-different-addressing-methods-2" class="insight-link-block w-inline-block"><div class="insight-card"><div class="card-left"><img alt="" loading="lazy" width="88" src="../images/01-white-isotype-40png-1.png" class="card-logo-image"/><div class="card-title-text">ASM 2 Tutorial - Different Addressing Methods</div></div><div style="background-image:url(&quot;../images/pexels-photo-5952647.jpeg&quot;)" class="card-right"></div></div><h2 class="card-title _30px">ASM 2 Tutorial - Different Addressing Methods</h2><div class="publish-date">March 19, 2021</div></a></div><div role="listitem" class="insight-item more w-dyn-item"><a href="/insights/asm-1-tutorial-absolute-basics" class="insight-link-block w-inline-block"><div class="insight-card"><div class="card-left"><img alt="" loading="lazy" width="88" src="../images/01-white-isotype-40png-1.png" class="card-logo-image"/><div class="card-title-text">ASM 1 Tutorial: Absolute Basics</div></div><div style="background-image:url(&quot;../images/img0.webp&quot;)" class="card-right"></div></div><h2 class="card-title _30px">ASM 1 Tutorial: Absolute Basics</h2><div class="publish-date">July 14, 2020</div></a></div><div role="listitem" class="insight-item more w-dyn-item"><a href="/insights/exploiting-millennium-mp3-studio-2-0-with-shellcode-payload" class="insight-link-block w-inline-block"><div class="insight-card"><div class="card-left"><img alt="" loading="lazy" width="88" src="../images/01-white-isotype-40png-1.png" class="card-logo-image"/><div class="card-title-text">Exploiting Millennium MP3 Studio 2.0 with Shellcode Payload</div></div><div style="background-image:url(&quot;../images/img0-2.webp&quot;)" class="card-right"></div></div><h2 class="card-title _30px">Exploiting Millennium MP3 Studio 2.0 with Shellcode Payload</h2><div class="publish-date">June 8, 2020</div></a></div></div></div></div></div><div id="Footer" class="section footer"><div class="container"><h2 data-w-id="ae4b8e71-0363-414c-edd7-c73018081b98" class="large-text footer-heading">Security You Can Trust</h2><div class="footer-content-contain"><div class="footer-flex"><div class="footer-left"><p data-w-id="ae4b8e71-0363-414c-edd7-c73018081b9d">As we are passionate about this industry, security and research comes as a second nature for us providing our customers with unmatched results. Let&#x27;s get in touch!</p><div class="footer-contact-links-wrap"><a data-w-id="ae4b8e71-0363-414c-edd7-c73018081ba0" href="#" class="link-block w-inline-block"><div class="link-block-left"><img src="../images/free-mail-icon-142-thumb.png" loading="eager" width="20" alt="" class="contact-icon"/><div class="contact-type">Email</div></div><div class="link-block-center"><div class="contact-symbol">@</div></div><div class="link-block-right"><div class="contact">hello@darkwaves.io</div></div><div class="link-block-border"><div class="link-block-hover-border"></div></div></a><a data-w-id="ae4b8e71-0363-414c-edd7-c73018081bad" href="https://twitter.com/DarkWaves_Sec" target="_blank" class="link-block w-inline-block"><div class="link-block-left"><img src="../images/81609.png" loading="eager" width="20" sizes="20px" alt="" srcset="../images/81609-p-500.png 500w, ../images/81609-1.png 512w" class="contact-icon"/><div class="contact-type">Twitter</div></div><div class="link-block-center"><img src="../images/contact-20arrow.svg" loading="lazy" width="16" alt="" class="contact-arrow"/></div><div class="link-block-right"><div class="contact">@DarkWaves_Sec</div></div><div class="link-block-border"><div class="link-block-hover-border"></div></div></a><a data-w-id="ae4b8e71-0363-414c-edd7-c73018081bb9" href="https://www.linkedin.com/company/dwsec" target="_blank" class="link-block w-inline-block"><div class="link-block-left"><img src="../images/174857.png" loading="eager" width="20" sizes="20px" alt="" srcset="../images/174857-p-500.png 500w, ../images/174857-1.png 512w" class="contact-icon"/><div class="contact-type">LinkedIn</div></div><div class="link-block-center"><img src="../images/contact-20arrow.svg" loading="lazy" width="16" alt="" class="contact-arrow"/></div><div class="link-block-right"><div class="contact">@dwsec</div></div><div class="link-block-border"><div class="link-block-hover-border"></div></div></a></div></div><div class="footer-right"><h3 data-w-id="ae4b8e71-0363-414c-edd7-c73018081bde" class="footer-address">DARK WAVES INFOSEC LTD<br/>71-75 Shelton Street<br/>Covent Garden<br/>London<br/>WC2H 9JQ</h3><div class="_20px-height-gap-div"></div><div data-w-id="ae4b8e71-0363-414c-edd7-c73018081be5" class="copyrights">Copyright © Dark Waves Infosec LTD.<br/></div></div></div></div></div></div><script src="../js/jquery.js" type="text/javascript"  ></script><script src="../js/webflow-script.js" type="text/javascript"></script></body></html>