<!DOCTYPE html><!-- Last Published: Fri Jan 12 2024 08:39:01 GMT+0000 (Coordinated Universal Time) --><html data-wf-page="6572f99ba87060097855250a" data-wf-site="63b6d5e577ebd8b19dbf7bfe" data-wf-collection="6572f99ba87060097855251a" data-wf-item-slug="exploiting-millennium-mp3-studio-2-0-with-shellcode-payload"><head><meta charset="utf-8"/><title>Dark Waves Infosec Ltd</title><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="../css/dwsec.webflow.1049a7f6a.min.css" rel="stylesheet" type="text/css"/><script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script><link href="../images/favicon.png" rel="shortcut icon" type="image/x-icon"/><link href="../images/app-icon.png" rel="apple-touch-icon"/></head><body><div data-animation="default" data-collapse="medium" data-duration="400" data-easing="ease" data-easing2="ease" role="banner" class="navbar w-nav"><div class="container navbar-container"><a href="/" class="home-link w-inline-block"><img src="../images/02-white-isologotype-403x.png" loading="lazy" width="150" sizes="(max-width: 479px) 90px, (max-width: 767px) 120px, 150px" alt="" srcset="../images/02-white-isologotype-403x-p-500.png 500w, ../images/02-white-isologotype-403x-1.png 901w" class="logo"/></a><div class="menu-button w-nav-button"><div class="w-icon-nav-menu"></div></div><nav role="navigation" class="nav-menu w-nav-menu"><div class="navbar-menu-items"><a href="/about-us" class="nav-link w-inline-block"><div>About us</div><div class="nav-link-line"></div></a><a href="/services" class="nav-link w-inline-block"><div>Services</div><div class="nav-link-line"></div></a><a href="/insights" class="nav-link w-inline-block"><div>Insights</div><div class="nav-link-line"></div></a><a href="#" class="button navbar-button w-button">Contact us</a></div></nav></div></div><div class="section insight-template"><div class="scroll-indicator scroll_indicator"></div><div class="container centered"><div class="insight-header-image-contain"><div class="insight-title-wrap"><h2 class="insight-title">Exploiting Millennium MP3 Studio 2.0 with Shellcode Payload</h2><div class="insight-date">June 8, 2020</div></div><div style="background-image:url(&quot;../images/img0-2.webp&quot;)" class="insight-header-image"></div></div><div class="insight-post-contain"><div class="inisght-rich-text-block w-richtext"><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img1-1.webp" loading="lazy" alt=""/></div></figure><p>‍</p><p>(<strong>This blog post is not original</strong>. It covers my experience and the challenges I encountered while replicating this exploit: <a href="https://fullpwnops.com/local-seh-overflow/?ref=dwsec-blog">https://fullpwnops.com/local-seh-overflow/</a> in Fu11Shade’s “Windows exploitation pathway” sequence. Unless otherwise stated, quoted text is from Fu11Shade’s blog post. To configure your system to follow along with this tutorial complete: <a href="https://fullpwnops.com/immunity-windbg-mona/?ref=dwsec-blog">https://fullpwnops.com/immunity-windbg-mona/</a>)</p><p>In this tutorial we’ll be exploiting an overflow that occurs when Millennium MP3 Studio 2.0 (install here: <a href="https://www.exploit-db.com/exploits/10240?ref=dwsec-blog">https://www.exploit-db.com/exploits/10240</a>) attempts to open files with certain extensions. I completed this tutorial on a Windows 7 64-bit virtual machine.</p><p>Structured Exception Handler (SEH) based overflows work in many different ways. In this tutorial we’ll be using a text file to inject the malicious payload into the vulnerable field.</p><p>What the heck is a “structured exception handler?” Put rather crudely, a SEH is a piece of code designed to handle certain errors that may occur at runtime. Exception handlers can address both hardware and software faults. Some common handlers deal with issues like failing to free memory blocks, insufficient memory, attempting to access a restricted memory location, and etc.</p><p>If an exception arises and none of the handlers can resolve the issue, the program will likely terminate or produce some kind of unexpected output.</p><p>There are two SEH mechanisms:</p><ol role="list"><li>Exception handlers: blocks which can respond to or dismiss the exception</li><li>Termination handlers: blocks which are always called, whether an exception causes termination or not</li></ol><p>‍</p><p>When an exception is thrown that a handler recognizes, the handler can either:</p><ol role="list"><li>Fail to recognize the exception and pass control to other handlers</li><li>Recognize the exception but dismiss it</li><li>Recognize the exception and handle it</li></ol><p>‍</p><p>Let’s run through how this SEH exploit will work — much of this is to be explained:</p><ol role="list"><li>We attach the Millennium process to Immunity so we can observe the buffer overflow and the effects of the vulnerability precisely.</li><li>When our malicious file is opened, the application will attempt to parse the data.</li><li>Fu11Shade tells us that there’s a buffer overflow when this application’s parsing program operates on files with a “.mpf” extension.</li><li>So, we need to create a .mpf file that overflows this buffer.</li><li>When an exception is raised, control will jump to the first SEH handler.</li><li>The buffer overflow will have set the address of the SEH handler to be the address of the POP POP RET sequence.</li><li>This will move ESP down the stack twice and return it to EIP.</li><li>Presumably, we’ve overwritten this address and EIP now points to a JMP instruction which moves execution to the start of the shellcode.</li></ol><p>‍</p><p>Let’s get started:</p><p>First, we want to attach the Immunity Debugger to the running Millennium MP3 Studio process:</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img2-2.webp" loading="lazy" alt=""/></div></figure><p>‍</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img3-1.webp" loading="lazy" alt=""/></div></figure><p>‍</p><p>Next, we want to generate the .mpf file for our exploit. We can do this using a python script:</p><p><br/></p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img4-2.webp" loading="lazy" alt=""/></div></figure><p>‍</p><p>In this script we generate a payload, open a file named “evil.mpf”, and write the payloads the payload to the file object returned by open() (payload_execution).</p><p>After running the script we can see the malicious file.</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img5-2.webp" loading="lazy" alt=""/></div></figure><p>‍</p><p>Now let’s try to open evil.mpf from Millenium Studio MP3 while its attached to Immunity:</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img6-2.webp" loading="lazy" alt=""/></div></figure><p>‍</p><p>We can see the EAX and ECX registers being overwritten with A’s. </p><p>Furthermore, we can see a “CORRUPT ENTRY” in our SEH chain:</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img7-1.webp" loading="lazy" alt=""/></div></figure><p>‍</p><p>‍</p><p>Finally, we can also see the overflow in Immunity’s logs.</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img8-1.webp" loading="lazy" alt=""/></div></figure><p>‍</p><p>Now that we’ve confirmed there’s a buffer overflow vulnerability, we need to calculate the buffer size so we can generate precise shellcode designed to overwrite SEH handlers.</p><p>We can use Metasploit’s pattern create tool to generate a cyclic pattern that will help you identify where data starts being overwritten:</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img9-1.webp" loading="lazy" alt=""/></div></figure><p>‍</p><blockquote><strong>Note</strong>: I had issues installing the Metasploit framework on my Windows virtual machine (Metasploit community is no longer offered) and opted to use the Metaploit framework that comes built-in with Kali Linux.</blockquote><p>‍</p><p>Now, we should attach the Millennium process to Immunity and open our new malicious file:</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img10-1.webp" loading="lazy" alt=""/></div></figure><p>‍</p><p>We can see registers being overwritten by our pattern.</p><p>Now, lets run the “findmsp” command. Findmsp will “find all instances or certain references to a cyclic pattern in memory” (corelan.be). If you inject a cyclic pattern and crash your application you can run findmsp to obtain the following information (corelan.be):</p><p>“””</p><ol role="list"><li>Locations where the cyclic pattern can be found and how long that pattern is.</li><li>Registers that are overwritten with a 4-byte cyclic pattern and the offset required to overwrite the register.</li><li>Registers that point into a cyclic pattern, the offset, and the remaining size of the pattern.</li><li>SEH records overwritten with 4-bytes of a cyclic, offset, and size.</li><li>Pointers on the current thread stack, into a cyclic pattern (offset + size).</li><li>Parts of a cyclic pattern on the stack, the offset from the beginning of the pattern and the size of the pattern.</li></ol><p>“””</p><p>We can see a SEH handler being overwritten:</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img11.webp" loading="lazy" alt=""/></div></figure><p>‍</p><p>In order to exploit this “we need to obtain a POP POP RET gadget.” Using we can accomplish this using mona by running “!mona seh -n” in Immunity. This command will search through the program for the needed sequence which will “return execution flow back to the structured exception handler.”</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img12.webp" loading="lazy" alt=""/></div></figure><p>‍</p><p>At first I didn’t know what a POP POP RET gadget <em>really </em>was or why we needed it — so let’s explore that a bit.</p><p>According to dkalemis.wordpress.com, exploit writers often search for this sequence “because it is an essential part of their exploit.” Apparently, “POP POP RET is the sequence of instructions needed in order to create SEH exploits.” Notably, the registers to which the popped values go is not of critical importance to whether the exploits succeed. What matters most is that ESP is moved up the address space twice (8 bytes — each position is 4-bytes on a 32-bit architecture), and that a RET instruction is executed. Therefore, either a “POP EAX, POP EBX, RET, or POP ECX, POP ECX, RET, or POP EDX, POP EAX, RET, (and so on) will do.”</p><p>Each time a RET occurs, “the contents of the address ESP points at are put in EIP and executed,” (dkalemis). So, the attacker knows that the address of ESP + 8 is going to be put into EIP and executed.</p><p>But why is it important that ESP be moved down the stack twice? Why can’t we just overwrite the SEH handler instructions with shellcode since control jumps there anyways when an exception is raised?</p><p>Because there are SafeSEH safeguards that protect against this.</p><p>According to Dkalemis, SEH’s are “a linked list of records with each record corresponding to an exception handler.” The first field of the record is a pointer to the next record and the second field is the address of the exception handler itself.</p><p>SEH exploits are based on the fact that the attacker can “alter a portion of the stack and put values there that can misdirect the execution of the SEH handler after an exception is raised,” (dkalemis).</p><p>So, let’s run through how a POP POP RET gadget would work from the top:</p><ol role="list"><li>After a buffer overflow is raise execution jumps to the address pointed to by the first SEH handler.</li><li>The buffer overflow set the address of the SEH handler to be the address of the POP POP RET sequence.</li><li>So now EIP will be set to the value of ESP + 8 bytes which will be a jmp instruction to the start of the shellcode.</li></ol><p>Moving back to the tutorial now.</p><p>Our final python script, which includes the POP POP RET gadget, will look like this:</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img13.png" loading="lazy" alt=""/></div></figure><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img14.png" loading="lazy" alt=""/></div></figure><p>Notice that our payload now also contains a NOP sled.</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img15.webp" loading="lazy" alt=""/></div></figure><p>‍</p><p>Now, when we run the final version of the application we can get a calculator to pop up.</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="../images/img16.webp" loading="lazy" alt=""/></div></figure></div></div></div></div><div class="section more-insights"><div class="container"><div class="insights-header-flex no-left-padding"><h2 class="dark-text">Explore more insights</h2></div><div class="insights-list-wrapper w-dyn-list"><div role="list" class="insights-list w-dyn-items"><div role="listitem" class="insight-item more w-dyn-item"><a href="/insights/seh-overflow-with-multi-staged-jumps" class="insight-link-block w-inline-block"><div class="insight-card"><div class="card-left"><img alt="" loading="lazy" width="88" src="../images/01-white-isotype-40png-1.png" class="card-logo-image"/><div class="card-title-text">SEH Overflow with Multi-Staged Jumps</div></div><div style="background-image:url(&quot;../images/img0-1.webp&quot;)" class="card-right"></div></div><h2 class="card-title _30px">SEH Overflow with Multi-Staged Jumps</h2><div class="publish-date">June 26, 2020</div></a></div><div role="listitem" class="insight-item more w-dyn-item"><a href="/insights/asm-1-tutorial-absolute-basics" class="insight-link-block w-inline-block"><div class="insight-card"><div class="card-left"><img alt="" loading="lazy" width="88" src="../images/01-white-isotype-40png-1.png" class="card-logo-image"/><div class="card-title-text">ASM 1 Tutorial: Absolute Basics</div></div><div style="background-image:url(&quot;../images/img0.webp&quot;)" class="card-right"></div></div><h2 class="card-title _30px">ASM 1 Tutorial: Absolute Basics</h2><div class="publish-date">July 14, 2020</div></a></div><div role="listitem" class="insight-item more w-dyn-item"><a href="/insights/asm-2-tutorial-different-addressing-methods-2" class="insight-link-block w-inline-block"><div class="insight-card"><div class="card-left"><img alt="" loading="lazy" width="88" src="../images/01-white-isotype-40png-1.png" class="card-logo-image"/><div class="card-title-text">ASM 2 Tutorial - Different Addressing Methods</div></div><div style="background-image:url(&quot;../images/pexels-photo-5952647.jpeg&quot;)" class="card-right"></div></div><h2 class="card-title _30px">ASM 2 Tutorial - Different Addressing Methods</h2><div class="publish-date">March 19, 2021</div></a></div><div role="listitem" class="insight-item more w-dyn-item"><a href="/insights/think-offensive-leverage-osquery-for-discovery-and-enumeration" class="insight-link-block w-inline-block"><div class="insight-card"><div class="card-left"><img alt="" loading="lazy" width="88" src="" class="card-logo-image w-dyn-bind-empty"/><div class="card-title-text">Think Offensive - Leverage OSQuery for Discovery and Enumeration</div></div><div style="background-image:url(&quot;../images/osquery-1.jpeg&quot;)" class="card-right"></div></div><h2 class="card-title _30px">Think Offensive - Leverage OSQuery for Discovery and Enumeration</h2><div class="publish-date">June 29, 2023</div></a></div></div></div></div></div><div id="Footer" class="section footer"><div class="container"><h2 data-w-id="ae4b8e71-0363-414c-edd7-c73018081b98" class="large-text footer-heading">Security You Can Trust</h2><div class="footer-content-contain"><div class="footer-flex"><div class="footer-left"><p data-w-id="ae4b8e71-0363-414c-edd7-c73018081b9d">As we are passionate about this industry, security and research comes as a second nature for us providing our customers with unmatched results. Let&#x27;s get in touch!</p><div class="footer-contact-links-wrap"><a data-w-id="ae4b8e71-0363-414c-edd7-c73018081ba0" href="#" class="link-block w-inline-block"><div class="link-block-left"><img src="../images/free-mail-icon-142-thumb.png" loading="eager" width="20" alt="" class="contact-icon"/><div class="contact-type">Email</div></div><div class="link-block-center"><div class="contact-symbol">@</div></div><div class="link-block-right"><div class="contact">hello@darkwaves.io</div></div><div class="link-block-border"><div class="link-block-hover-border"></div></div></a><a data-w-id="ae4b8e71-0363-414c-edd7-c73018081bad" href="https://twitter.com/DarkWaves_Sec" target="_blank" class="link-block w-inline-block"><div class="link-block-left"><img src="../images/81609.png" loading="eager" width="20" sizes="20px" alt="" srcset="../images/81609-p-500.png 500w, ../images/81609-1.png 512w" class="contact-icon"/><div class="contact-type">Twitter</div></div><div class="link-block-center"><img src="../images/contact-20arrow.svg" loading="lazy" width="16" alt="" class="contact-arrow"/></div><div class="link-block-right"><div class="contact">@DarkWaves_Sec</div></div><div class="link-block-border"><div class="link-block-hover-border"></div></div></a><a data-w-id="ae4b8e71-0363-414c-edd7-c73018081bb9" href="https://www.linkedin.com/company/dwsec" target="_blank" class="link-block w-inline-block"><div class="link-block-left"><img src="../images/174857.png" loading="eager" width="20" sizes="20px" alt="" srcset="../images/174857-p-500.png 500w, ../images/174857-1.png 512w" class="contact-icon"/><div class="contact-type">LinkedIn</div></div><div class="link-block-center"><img src="../images/contact-20arrow.svg" loading="lazy" width="16" alt="" class="contact-arrow"/></div><div class="link-block-right"><div class="contact">@dwsec</div></div><div class="link-block-border"><div class="link-block-hover-border"></div></div></a></div></div><div class="footer-right"><h3 data-w-id="ae4b8e71-0363-414c-edd7-c73018081bde" class="footer-address">DARK WAVES INFOSEC LTD<br/>71-75 Shelton Street<br/>Covent Garden<br/>London<br/>WC2H 9JQ</h3><div class="_20px-height-gap-div"></div><div data-w-id="ae4b8e71-0363-414c-edd7-c73018081be5" class="copyrights">Copyright © Dark Waves Infosec LTD.<br/></div></div></div></div></div></div><script src="../js/jquery.js" type="text/javascript"  ></script><script src="../js/webflow-script.js" type="text/javascript"></script></body></html>